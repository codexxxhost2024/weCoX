<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WeShop - Loading...</title>
    <meta name="theme-color" content="#1F3A5C"> <!-- WeConnect Theme Color -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Material Symbols Outlined -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400..700,0..1,-50..200" />
    <!-- Inter Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">

    <style>
        :root {
            /* --- WeConnect Theme Variables --- */
            --primary-color: #1F3A5C;
            --primary-color-darker: #142840;
            --primary-color-light-bg: rgba(31, 58, 92, 0.08);
            --accent-color: #4A90E2;
            --accent-color-darker: #357ABD;
            --background-main: #f0f2f5;
            --background-card: #ffffff;
            --background-card-subtle: #f8f9fa;
            --text-dark: #212B36;
            --text-medium: #555e6f;
            --text-light: #919EAB;
            --text-on-primary: #FFFFFF;
            --text-on-dark-bg: #FFFFFF;
            --border-color: #e0e6ed;
            --danger-color: #FF5630;
            --heart-color: #FF5630;

            --border-radius-sm: 6px;
            --border-radius-md: 12px;
            --border-radius-lg: 16px;
            --border-radius-pill: 50px;

            --header-height: 70px;
            --transition-speed: 0.2s;
            --spacing-unit: 16px;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        html, body { overflow-x: hidden; max-width: 100%; touch-action: pan-y; background-color: var(--background-main); color: var(--text-medium); line-height: 1.5; }
        .container { max-width: 100%; padding-top: var(--header-height); padding-bottom: 20px; }
        a { color: var(--primary-color); text-decoration: none; }
        button { cursor: pointer; }
        img { display: block; max-width: 100%; height: auto; }

        /* Material Symbol Icons adjustments */
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            vertical-align: middle;
            line-height: 1; /* Better alignment */
            font-size: 24px; /* Default size */
        }

        /* Header */
        .header-wrapper { /* Fixed wrapper for header */
            position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
            background-color: var(--background-main);
            height: var(--header-height);
            display: flex; align-items: center; /* Center items vertically */
        }
        .header { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 0 var(--spacing-unit); }
        .header-left { display: flex; align-items: center; gap: 10px; }
        .menu-btn, .notification-bell-btn, .profile-btn { background: none; border: none; padding: 0; cursor: pointer; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background-color: var(--background-card); color: var(--text-medium); box-shadow: var(--shadow-sm); transition: background-color var(--transition-speed); }
        .menu-btn:hover, .notification-bell-btn:hover, .profile-btn:hover { background-color: #eee; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .profile-pic { width: 44px; height: 44px; border-radius: 50%; object-fit: cover; background-color: var(--border-color); border: 1px solid var(--border-color); }
        .greeting span { display: block; font-size: 13px; color: var(--text-light); }
        .greeting strong { display: block; font-size: 16px; font-weight: 600; color: var(--text-dark); }
        .header-right { display: flex; align-items: center; gap: 10px; }
        .notification-bell-btn { position: relative; }
        .notification-badge { position: absolute; top: 6px; right: 6px; background-color: var(--danger-color); color: white; border-radius: 50%; width: 10px; height: 10px; border: 1.5px solid var(--background-card); }
        .notification-badge.hidden { display: none; }

        /* Body Padding for Fixed Header */
        body { padding-top: var(--header-height); }

        /* Search & Filter Row */
        .search-filter-row { display: flex; gap: 10px; padding: 10px var(--spacing-unit); align-items: center; }
        .search-bar { display: flex; align-items: center; background-color: var(--background-card); border-radius: var(--border-radius-md); padding: 10px 15px; flex-grow: 1; box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); }
        .search-bar .material-symbols-outlined { color: var(--text-light); margin-right: 10px; font-size: 22px; }
        .search-bar input { flex: 1; border: none; background: transparent; outline: none; font-size: 14px; color: var(--text-dark); }
        .search-bar input::placeholder { color: var(--text-light); }
        .filter-btn { background-color: var(--background-card); color: var(--primary-color); border-radius: var(--border-radius-md); width: 44px; height: 44px; flex-shrink: 0; border: none; box-shadow: var(--shadow-sm); display: flex; align-items: center; justify-content: center; }
        .filter-btn:hover { background-color: #eee; }
        .filter-btn .material-symbols-outlined { font-size: 24px; }

        /* Promo Banner */
        .promo-banner { margin: 0 var(--spacing-unit) var(--spacing-unit); border-radius: var(--border-radius-lg); overflow: hidden; display: flex; background: linear-gradient(100deg, #1a2f3d 55%, #f8c146 55%); box-shadow: var(--shadow-md); position: relative; color: var(--text-on-dark-bg); }
        .banner-text { padding: 20px 25px; flex: 1; z-index: 2;}
        .banner-text h2 { font-size: 18px; font-weight: 600; margin-bottom: 5px; }
        .banner-text p { font-size: 14px; opacity: 0.9; margin-bottom: 15px; line-height: 1.4; max-width: 200px;}
        .banner-text .view-more-link { color: var(--text-on-dark-bg); text-decoration: none; font-weight: 500; font-size: 14px; display: inline-flex; align-items: center; }
        .banner-text .view-more-link .material-symbols-outlined { margin-left: 5px; font-size: 20px; }
        .banner-image { position: relative; width: 45%; overflow: hidden; }
        .banner-image img { display: block; position: absolute; bottom: -20px; right: -30px; width: 150%; max-width: 250px; height: auto; }
        .sales-tag { position: absolute; top: 15px; right: -40px; background-color: var(--danger-color); color: white; padding: 8px 40px; transform: rotate(45deg); transform-origin: top right; font-size: 11px; font-weight: bold; text-align: center; z-index: 3; }
        .sales-tag span { display: block; font-size: 14px; font-weight: 600;}

        /* Categories */
        .categories-container { padding: 0 var(--spacing-unit); margin-bottom: var(--spacing-unit); }
        .categories { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 10px; scrollbar-width: none; }
        .categories::-webkit-scrollbar { display: none; }
        .category { flex: 0 0 auto; padding: 10px 20px; background-color: var(--background-card); border-radius: var(--border-radius-md); font-size: 14px; color: var(--text-medium); white-space: nowrap; cursor: pointer; transition: background-color 0.2s, color 0.2s; display: flex; align-items: center; gap: 6px; box-shadow: var(--shadow-sm); border: none; }
        .category.active { background-color: var(--primary-color); color: var(--text-on-primary); font-weight: 500; }
        .category .material-symbols-outlined { font-size: 20px; }
        .category:hover:not(.active) { background-color: #eee; }

        /* Product Section Header */
        .product-section { padding: 0 var(--spacing-unit); }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .section-title { font-size: 18px; font-weight: 600; color: var(--text-dark); }
        .view-all-link { font-size: 14px; color: var(--text-medium); text-decoration: none; font-weight: 500; }

        /* Products Grid */
        .products-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-unit); align-items: stretch; }
        .product-card-link { text-decoration: none; color: inherit; display: flex; flex-direction: column; height: 100%; }
        .product-card { background-color: var(--background-card); border-radius: var(--border-radius-lg); overflow: hidden; box-shadow: var(--shadow-sm); display: flex; flex-direction: column; height: 100%; position: relative; transition: box-shadow 0.2s; border: 1px solid var(--border-color); }
        .product-card-link:hover .product-card { box-shadow: var(--shadow-md); }
        .product-image { width: 100%; aspect-ratio: 1 / 1; overflow: hidden; position: relative; background-color: var(--background-card-subtle); }
        .product-image img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease; }
        .product-card-link:hover .product-image img { transform: scale(1.05); }
        .favorite-btn { position: absolute; top: 10px; right: 10px; background-color: rgba(255, 255, 255, 0.9); border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; z-index: 2; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: background-color 0.2s; }
        .favorite-btn:hover { background-color: #fff; }
        .favorite-btn .material-symbols-outlined { font-size: 18px; color: var(--text-light); transition: color 0.2s, font-variation-settings 0.2s; font-variation-settings: 'FILL' 0; }
        .favorite-btn.favorited .material-symbols-outlined { color: var(--heart-color); font-variation-settings: 'FILL' 1; }
        .add-to-cart-btn { position: absolute; bottom: 10px; right: 10px; background-color: var(--text-dark); color: var(--text-on-primary); border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; z-index: 2; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: background-color 0.2s; }
        .add-to-cart-btn:hover { background-color: #000; }
        .add-to-cart-btn .material-symbols-outlined { font-size: 20px; }
        .add-to-cart-btn:disabled { background-color: var(--text-light); cursor: not-allowed; }
        .add-to-cart-btn .material-symbols-outlined.spin { animation: spin 1s linear infinite; }
        .product-details { padding: 12px; }
        .product-title { font-size: 15px; font-weight: 600; margin-bottom: 4px; color: var(--text-dark); display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; }

        /* Loading/Error/Empty States */
        .loading { display: flex; justify-content: center; align-items: center; height: 200px; width: 100%; grid-column: 1 / -1; }
        .loading-spinner { border: 4px solid var(--primary-color-light-bg); border-radius: 50%; border-top: 4px solid var(--primary-color); width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-message { text-align: center; padding: 20px; color: var(--danger-color); font-weight: bold; grid-column: 1 / -1; }
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px; text-align: center; min-height: 200px; color: var(--text-light); grid-column: 1 / -1; }
        .empty-state .material-symbols-outlined { font-size: 50px; color: #ccc; margin-bottom: 15px; }
        .empty-state h3 { font-size: 18px; color: var(--text-dark); margin-bottom: 10px; }
        .empty-state p { font-size: 14px; color: var(--text-medium); margin-bottom: 20px; }

         /* Responsive adjustments */
        @media (max-width: 360px) {
            .promo-banner { flex-direction: column; background: var(--primary-color); }
            .banner-image { width: 100%; height: 150px; position: relative; bottom: 0; right: 0; }
            .banner-image img { position: static; width: 100%; max-width: none; transform: none; }
            .sales-tag { top: 10px; right: 10px; transform: rotate(0deg); padding: 5px 10px; }
            .banner-text { padding: 15px; }
            .product-title { font-size: 14px; }
            .greeting strong { font-size: 15px; }
        }
        @media (min-width: 768px) {
             body { max-width: 1200px; padding-top: var(--header-height); }
             .header-wrapper { padding-left: calc((100% - 1200px) / 2 + var(--spacing-unit)); padding-right: calc((100% - 1200px) / 2 + var(--spacing-unit)); }
             .products-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
        }

    </style>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>
    <!-- Header -->
    <div class="header-wrapper">
        <header class="header">
            <div class="header-left">
                <button class="menu-btn" id="menuButton" title="Menu">
                    <span class="material-symbols-outlined">menu</span>
                </button>
                <div class="user-info">
                    <img src="assets/images/default-avatar.png" alt="User" class="profile-pic" id="profilePic">
                    <div class="greeting">
                        <span>Hello</span>
                        <strong id="userNameGreeting">Guest!</strong> <!-- Changed ID -->
                    </div>
                </div>
            </div>
            <div class="header-right">
                <button class="notification-bell-btn" id="notificationBell" title="Notifications">
                    <span class="material-symbols-outlined">notifications</span>
                    <div class="notification-badge hidden" id="notificationBadge"></div>
                </button>
                 <a href="userprofile.html" class="profile-btn" title="Profile">
                    <span class="material-symbols-outlined">account_circle</span>
                </a>
            </div>
        </header>
    </div>

    <main class="container">
        <!-- Search & Filter Row -->
        <div class="search-filter-row">
            <div class="search-bar">
                <span class="material-symbols-outlined">search</span>
                <input type="text" placeholder="Search here..." id="searchInput">
            </div>
            <button class="filter-btn" id="filterButton" title="Filters">
                <span class="material-symbols-outlined">tune</span>
            </button>
        </div>

        <!-- Promo Banner -->
        <section class="promo-banner">
             <div class="banner-text">
                <h2>Best Selling</h2>
                <p>Comforts & Modern life Stylish Sofa</p>
                <a href="#" class="view-more-link">
                    View More <span class="material-symbols-outlined">arrow_forward</span>
                </a>
            </div>
            <div class="banner-image">
                 <img src="assets/images/sofa-banner.png" alt="Stylish Sofa"> <!-- Placeholder path -->
                 <div class="sales-tag">MEGA SALE <span>60 % OFF</span></div>
            </div>
        </section>

        <!-- Categories -->
        <div class="categories-container">
            <div class="categories" id="categoriesContainer">
                <button class="category active" data-category="all">
                    <span class="material-symbols-outlined">inventory_2</span> All
                </button>
                <button class="category" data-category="Food">
                    <span class="material-symbols-outlined">restaurant</span> Food
                </button>
                <button class="category" data-category="Apparel">
                    <span class="material-symbols-outlined">apparel</span> Apparel
                </button>
                 <button class="category" data-category="Vegetables">
                    <span class="material-symbols-outlined">eco</span> Vegetables
                </button>
                <button class="category" data-category="Groceries">
                    <span class="material-symbols-outlined">local_grocery_store</span> Groceries
                </button>
                 <button class="category" data-category="Digital Products">
                    <span class="material-symbols-outlined">computer</span> Digital Products
                 </button>
                 <button class="category" data-category="Others">
                     <span class="material-symbols-outlined">category</span> Others
                 </button>
            </div>
        </div>

        <!-- New Arrivals Section -->
        <section class="product-section">
            <div class="section-header">
                <h2 class="section-title">New Arrivals</h2>
                <a href="#" class="view-all-link" id="viewAllNewArrivals">View All</a>
            </div>
            <div class="loading" id="loadingIndicator">
                <div class="loading-spinner"></div>
            </div>
            <div class="error-message" id="errorMessage" style="display: none;"></div>
            <div class="products-grid" id="productsGrid" style="display: none;">
                 <!-- Products Loaded Here -->
            </div>
            <div class="empty-state" id="emptyState" style="display: none;">
                <span class="material-symbols-outlined">production_quantity_limits</span>
                <h3>No Products Found</h3>
                <p>There are currently no products matching your search or filter.</p>
            </div>
        </section>
        <div style="height: 80px;"></div> <!-- Spacer -->

    </main>

    <script>
        // --- Firebase Configuration (WeConnect) ---
const firebaseConfig = {
  apiKey: "AIzaSyBdZM_2Dgibm-S9pftZBUqOdGVup9oNhmU",
  authDomain: "ai-connect-2nbpnn.firebaseapp.com",
  databaseURL: "https://ai-connect-2nbpnn-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "ai-connect-2nbpnn",
  storageBucket: "ai-connect-2nbpnn.appspot.com",
  messagingSenderId: "704482029158",
  appId: "1:704482029158:web:2da7baab059274e0e447a7"
};
        // --- Initialize Firebase ---
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();
        const productsCollectionRef = db.collection('weshop_products');
        const usersCollectionRef = db.collection('users');
        const cartItemsCollectionRef = db.collection("cartItems");

        // --- DOM Elements ---
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessage = document.getElementById('errorMessage');
        const emptyState = document.getElementById('emptyState');
        const productsGrid = document.getElementById('productsGrid');
        const searchInput = document.getElementById('searchInput');
        const categoriesContainer = document.getElementById('categoriesContainer');
        const profilePic = document.getElementById('profilePic');
        const userNameGreeting = document.getElementById('userNameGreeting'); // Changed ID
        const notificationBadge = document.getElementById('notificationBadge');

        // --- App State ---
        let currentUser = null;
        let allProducts = [];
        let currentCategory = 'all';
        let unsubscribeCartListener = null;

        // --- Authentication ---
        auth.onAuthStateChanged(user => {
            if (user) {
                console.log("User logged in:", user.uid);
                currentUser = user;
                fetchUserData(user.uid); // Fetch user data on login
                initializeCartListener(user.uid);
                initializePage();
            } else {
                console.log("No user logged in. Redirecting to signin...");
                currentUser = null;
                if (unsubscribeCartListener) unsubscribeCartListener();
                window.location.href = '/signin.html';
            }
        });

        // --- Fetch User Data ---
        async function fetchUserData(uid) {
            try {
                const userDoc = await usersCollectionRef.doc(uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    // *** MODIFIED: Display Member ID ***
                    const memberId = userData.memberId || 'User'; // Use memberId field, fallback to 'User'
                    userNameGreeting.textContent = `ID: ${memberId}`; // Display ID
                    // Use photoURL field if available, otherwise use default
                    profilePic.src = userData.photoURL || 'assets/images/default-avatar.png';
                } else {
                    console.warn("User document not found.");
                    userNameGreeting.textContent = 'User ID'; // Default greeting
                    profilePic.src = 'assets/images/default-avatar.png'; // Default pic
                }
            } catch (error) {
                console.error("Error fetching user data:", error);
                userNameGreeting.textContent = 'User ID'; // Default on error
                profilePic.src = 'assets/images/default-avatar.png';
            }
        }

        // --- Cart Listener ---
        function initializeCartListener(userId) {
            if (unsubscribeCartListener) unsubscribeCartListener();
            const query = cartItemsCollectionRef.where("userId", "==", userId);
            unsubscribeCartListener = query.onSnapshot(snapshot => {
                updateCartIcon(snapshot.size);
            }, error => {
                console.error("Error listening to cart updates:", error);
                updateCartIcon(0);
            });
        }

        // --- Update Cart Icon ---
        function updateCartIcon(count) {
            const displayCount = Math.max(0, count);
            if (notificationBadge) {
                 if (displayCount > 0) {
                    notificationBadge.textContent = displayCount > 9 ? '9+' : displayCount.toString();
                    notificationBadge.classList.remove('hidden');
                 } else {
                    notificationBadge.classList.add('hidden');
                 }
            }
        }

        // --- Initialize Page ---
        async function initializePage() {
            if (!currentUser) return;
            showLoading();
            try {
                allProducts = await fetchProducts();
                applyFilters();
                setupEventListeners();
            } catch (error) {
                showError("Could not load store. Please try again later.");
            } finally {
                hideLoading();
            }
        }

        // --- Fetch Products ---
        async function fetchProducts() {
            console.log("Fetching products from 'weshop_products'");
            try {
                const snapshot = await productsCollectionRef.where("Status", "==", "active").get();
                const productsArray = [];
                snapshot.forEach(doc => productsArray.push({ id: doc.id, ...doc.data() }));
                console.log(`Fetched ${productsArray.length} active products.`);
                return productsArray;
            } catch (error) { console.error("Error fetching products:", error); throw error; }
        }

        // --- Setup Event Listeners ---
        function setupEventListeners() {
            let searchTimeout;
            searchInput.addEventListener('input', () => { clearTimeout(searchTimeout); searchTimeout = setTimeout(applyFilters, 300); });
            categoriesContainer.addEventListener('click', (event) => {
                 const categoryButton = event.target.closest('.category');
                 if (categoryButton) {
                     if (categoryButton.classList.contains('active')) return;
                     categoriesContainer.querySelectorAll('.category').forEach(c => c.classList.remove('active'));
                     categoryButton.classList.add('active');
                     currentCategory = categoryButton.dataset.category;
                     applyFilters();
                 }
             });
            productsGrid.addEventListener('click', async (event) => {
                 const addToCartButton = event.target.closest('.add-to-cart-btn');
                 const favoriteButton = event.target.closest('.favorite-btn');
                 const cardLink = event.target.closest('.product-card-link');
                 const productId = cardLink?.dataset.productId;

                 if (addToCartButton) {
                     event.preventDefault();
                     if (!productId) return;
                     addToCartButton.innerHTML = `<span class="material-symbols-outlined spin" style="font-size: 18px;">autorenew</span>`;
                     addToCartButton.disabled = true;
                     await handleAddToCart(productId, addToCartButton);
                 }
                 else if (favoriteButton) {
                     event.preventDefault();
                     if (!productId) return;
                     favoriteButton.classList.toggle('favorited');
                     console.log(`Toggled favorite for product: ${productId}`);
                     // Add favorite logic here
                 }
             });
        }

        // --- Handle Add To Cart ---
        async function handleAddToCart(productId, buttonElement) {
            if (!currentUser) { showErrorToast("Please sign in first."); buttonElement.innerHTML = `<span class="material-symbols-outlined">shopping_bag</span>`; buttonElement.disabled = false; return; }
            const product = allProducts.find(p => p.id === productId);
            if (!product) { showErrorToast("Product details not found."); buttonElement.innerHTML = `<span class="material-symbols-outlined">shopping_bag</span>`; buttonElement.disabled = false; return; }

            const cartItem = { userId: currentUser.uid, productId: product.id, productTitle: product.Title || product.name || 'Product', productPrice: parseFloat(product['Variant Price'] ?? product.price ?? 0), productImage: product['Image Src'] ?? (Array.isArray(product.imageUrls) && product.imageUrls[0]) ?? '', quantity: 1, addedAt: firebase.firestore.FieldValue.serverTimestamp() };

            try {
                const querySnapshot = await cartItemsCollectionRef.where('userId', '==', currentUser.uid).where('productId', '==', productId).limit(1).get();
                if (!querySnapshot.empty) {
                    const docRef = querySnapshot.docs[0].ref;
                    const currentQuantity = querySnapshot.docs[0].data().quantity || 0;
                    await docRef.update({ quantity: currentQuantity + 1 });
                } else { await cartItemsCollectionRef.add(cartItem); }
                buttonElement.innerHTML = `<span class="material-symbols-outlined">check</span>`;
                setTimeout(() => { buttonElement.innerHTML = `<span class="material-symbols-outlined">shopping_bag</span>`; buttonElement.disabled = false; }, 1500);
            } catch (error) { console.error("Error adding/updating cart:", error); showErrorToast("Failed to add item."); buttonElement.innerHTML = `<span class="material-symbols-outlined">shopping_bag</span>`; buttonElement.disabled = false; }
        }
        function showErrorToast(message) { alert(message); } // Placeholder

        // --- Apply Filters and Render ---
        function applyFilters() {
            const searchTerm = searchInput.value.trim();
            showLoading();
            setTimeout(() => {
                let filtered = filterProductsByCategory(allProducts, currentCategory);
                filtered = filterProductsBySearch(filtered, searchTerm);
                renderProducts(filtered);
                hideLoading();
            }, 50);
        }

        // --- Filter Logic ---
        function filterProductsByCategory(products, category) {
             // If 'Others' is selected, we might need a more complex logic
             // depending on how 'Others' is defined. For now, treat 'Others' like 'All'
             // or filter out products that match specific main categories.
             // Simple approach: treat 'Others' like 'All' for now.
             if (category === 'all' || category === 'Others') return products;

             const lcCat = category.toLowerCase();
             return products.filter(p => {
                 const type = (p.Type ?? p.category ?? '').toLowerCase();
                 const pCat = (p['Product Category'] ?? '').toLowerCase();
                 let tagsMatch = false;
                 const tags = p.Tags ?? [];
                 // Exact match for tags might be better if categories are specific
                 if (Array.isArray(tags)) tagsMatch = tags.some(t => String(t).toLowerCase() === lcCat);
                 else if (typeof tags === 'string') tagsMatch = tags.toLowerCase().split(',').map(t=>t.trim()).includes(lcCat);
                 // Match Type OR Category (contains) OR Tags (exact)
                 return type === lcCat || pCat.includes(lcCat) || tagsMatch;
             });
         }

         function filterProductsBySearch(products, searchTerm) {
             if (!searchTerm) return products;
             const lcSearch = searchTerm.toLowerCase();
             return products.filter(p => {
                 const title = (p.Title ?? p.name ?? '').toLowerCase();
                 const vendor = (p.Vendor ?? '').toLowerCase();
                 const type = (p.Type ?? p.category ?? '').toLowerCase();
                 let tagsMatch = false;
                 const tags = p.Tags ?? [];
                 if (Array.isArray(tags)) tagsMatch = tags.some(t => String(t).toLowerCase().includes(lcSearch));
                 else if (typeof tags === 'string') tagsMatch = tags.toLowerCase().includes(lcSearch);
                 // Search in Title, Vendor, Type/Category, Tags
                 return title.includes(lcSearch) || vendor.includes(lcSearch) || type.includes(lcSearch) || tagsMatch;
             });
         }


        // --- Render Products ---
        function renderProducts(products) {
            productsGrid.innerHTML = '';
            if (!Array.isArray(products)) { showError("Could not display products."); return; }
            if (products.length === 0) { showEmptyState(); return; }

            products.sort((a, b) => (a.Title || '').localeCompare(b.Title || '')); // Sort A-Z

            const fragment = document.createDocumentFragment();
            products.forEach(product => {
                const cardElement = createProductCardElement(product);
                fragment.appendChild(cardElement);
            });
            productsGrid.appendChild(fragment);
            productsGrid.style.display = 'grid';
            emptyState.style.display = 'none';
            errorMessage.style.display = 'none';
        }

        // --- Create Product Card HTML Element ---
        function createProductCardElement(product) {
            const imageSrc = product['Image Src'] ?? (Array.isArray(product.imageUrls) && product.imageUrls.length > 0 ? product.imageUrls[0] : null) ?? 'assets/images/placeholder.svg'; // Use your placeholder path
            const title = product.Title ?? product.name ?? 'Product';

            const productLink = document.createElement('a');
            productLink.className = 'product-card-link';
            productLink.href = `product-details.html?id=${product.id}`;
            productLink.dataset.productId = product.id;

            productLink.innerHTML = `
                <div class="product-card">
                    <div class="product-image">
                        <img src="${imageSrc}" alt="${title}" loading="lazy" onerror="this.onerror=null; this.src='assets/images/placeholder.svg';">
                    </div>
                    <button class="favorite-btn" title="Favorite">
                         <span class="material-symbols-outlined">favorite</span>
                    </button>
                    <div class="product-details">
                        <div class="product-title">${title}</div>
                    </div>
                     <button class="add-to-cart-btn" title="Add to Cart">
                         <span class="material-symbols-outlined">shopping_bag</span>
                     </button>
                </div>
            `;
            return productLink;
        }

        // --- UI State Functions ---
        function showLoading() { loadingIndicator.style.display = 'flex'; productsGrid.style.display = 'none'; errorMessage.style.display = 'none'; emptyState.style.display = 'none'; }
        function hideLoading() { loadingIndicator.style.display = 'none'; }
        function showError(message = "An error occurred.") { hideLoading(); errorMessage.textContent = message; errorMessage.style.display = 'block'; productsGrid.style.display = 'none'; emptyState.style.display = 'none'; }
        function showEmptyState(msg = "No Products Found", subMsg = "No products match your filter or search.") { hideLoading(); emptyState.querySelector('h3').textContent = msg; emptyState.querySelector('p').textContent = subMsg; emptyState.style.display = 'flex'; productsGrid.style.display = 'none'; errorMessage.style.display = 'none'; }

        // --- Prevent Zoom ---
        document.addEventListener('touchstart', (e) => { if (e.touches.length > 1) e.preventDefault(); }, { passive: false });
        document.addEventListener('touchmove', (e) => { if (e.touches.length > 1) e.preventDefault(); }, { passive: false });
        let lastTap = 0; document.addEventListener('touchend', (e) => { const currentTime = new Date().getTime(); const tapLength = currentTime - lastTap; if (tapLength < 300 && tapLength > 0) e.preventDefault(); lastTap = currentTime; }, false);

    </script>
     <!-- Bootstrap JS (Optional, only if needed for modals etc.) -->
     <!-- <script src="assets/js/bootstrap.bundle.min.js"></script> -->

</body>
</html><script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .then(registration => {
          console.log('Service Worker registered with scope:', registration.scope);
        })
        .catch(error => {
          console.error('Service worker registration failed:', error);
        });
    }
  <\/script>
